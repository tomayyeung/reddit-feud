import { CustomPostDefinition, RenderPostResponse } from '@devvit/protos';
import { Devvit } from '../Devvit.js';
import { BlocksReconciler } from './blocks/BlocksReconciler.js';
import { extendDevvitPrototype } from './helpers/extendDevvitPrototype.js';
async function renderPost(req, metadata) {
    const customPostType = Devvit.customPostType;
    if (!customPostType) {
        throw new Error('Custom post type not registered');
    }
    const reconciler = new BlocksReconciler((_props, context) => customPostType.render(context), req.blocks, req.state, metadata, req.dimensions);
    const blocksUI = await reconciler.render();
    return RenderPostResponse.fromJSON({
        state: reconciler.state,
        blocks: {
            ui: blocksUI,
        },
        effects: reconciler.getEffects(),
    });
}
export function registerCustomPost(config) {
    config.provides(CustomPostDefinition);
    extendDevvitPrototype('RenderPost', renderPost);
}
